name: release

on:
    push:
        branches:
            - main

permissions:
    contents: read
    id-token: write

jobs:
    release:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node 22
              uses: actions/setup-node@v4
              with:
                  node-version: '22'

            - name: Install dependencies
              run: npm ci

            - name: Check version and Publish
              run: |
                  PACKAGE_NAME=$(node -p "require('./package.json').name")
                  LOCAL_VERSION=$(node -p "require('./package.json').version")
                  NPM_VERSION=$(npm view $PACKAGE_NAME version 2>/dev/null || echo "0.0.0")

                  if npx semver "$LOCAL_VERSION" --range ">$NPM_VERSION"; then
                    echo "New version detected. Starting release..."
                    # Runs format, lint, typecheck, and test per your package.json
                    npm run everything
                    # 'prepublishOnly' in your package.json handles the build automatically
                    npm publish --provenance --access public
                  else
                    echo "Version $LOCAL_VERSION is not newer than $NPM_VERSION. Skipping."
                  fi
